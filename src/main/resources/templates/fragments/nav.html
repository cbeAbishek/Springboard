<div th:fragment="app-nav" th:with="publishableKey=${@clerkProperties.publishableKey}">
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <div class="sticky top-4 z-50 px-6 mb-8 mt-4">
        <nav class="container mx-auto backdrop-blur-md bg-slate-900/95 border border-slate-700/50 rounded-3xl shadow-2xl shadow-blue-500/10 hover:shadow-blue-500/20 transition-all duration-300 overflow-visible">
            <div class="flex items-center justify-between px-6 py-4 flex-wrap lg:flex-nowrap gap-4 relative z-10">
                <!-- Logo and Brand -->
                <div class="flex items-center gap-3 flex-shrink-0 relative z-20">
                    <a href="/" class="flex items-center gap-3 text-white font-bold text-lg hover:text-blue-400 transition-colors duration-200 group">
                        <img src="/images/logo.png" alt="Automation Platform" class="w-8 h-8 drop-shadow-lg group-hover:scale-110 transition-transform duration-200" loading="lazy">
                        <span class="hidden sm:inline bg-gradient-to-r from-blue-400 to-violet-400 bg-clip-text text-transparent">Automation Platform</span>
                    </a>
                </div>
                
                                <!-- Navigation Links - Always Visible on Desktop -->
                <div class="flex items-center gap-2 flex-1 justify-center relative z-20 max-md:hidden">
                    <a href="/dashboard" class="flex items-center gap-2 px-4 py-2.5 rounded-xl bg-slate-800/30 text-white hover:text-blue-300 hover:bg-slate-800/80 transition-all duration-200 group whitespace-nowrap relative">
                        <i data-lucide="layout-dashboard" class="w-5 h-5 text-blue-400"></i>
                        <span class="font-bold text-shadow">Dashboard</span>
                    </a>
                    <a href="/test-management" class="flex items-center gap-2 px-4 py-2.5 rounded-xl bg-slate-800/30 text-white hover:text-violet-300 hover:bg-slate-800/80 transition-all duration-200 group whitespace-nowrap relative">
                        <i data-lucide="flask-conical" class="w-5 h-5 text-violet-400"></i>
                        <span class="font-bold text-shadow">Tests</span>
                    </a>
                    <a href="/scheduler" class="flex items-center gap-2 px-4 py-2.5 rounded-xl bg-slate-800/30 text-white hover:text-amber-300 hover:bg-slate-800/80 transition-all duration-200 group whitespace-nowrap relative">
                        <i data-lucide="clock" class="w-5 h-5 text-amber-400"></i>
                        <span class="font-bold text-shadow">Scheduler</span>
                    </a>
                    <a href="/regression-monitoring" class="flex items-center gap-2 px-4 py-2.5 rounded-xl bg-slate-800/30 text-white hover:text-green-300 hover:bg-slate-800/80 transition-all duration-200 group whitespace-nowrap relative">
                        <i data-lucide="activity" class="w-5 h-5 text-green-400"></i>
                        <span class="font-bold text-shadow">Regression</span>
                    </a>
                    <a href="/reports" class="flex items-center gap-2 px-4 py-2.5 rounded-xl bg-slate-800/30 text-white hover:text-cyan-300 hover:bg-slate-800/80 transition-all duration-200 group whitespace-nowrap relative">
                        <i data-lucide="file-bar-chart" class="w-5 h-5 text-cyan-400"></i>
                        <span class="font-bold text-shadow">Reports</span>
                    </a>
                    <a href="/docs" class="flex items-center gap-2 px-4 py-2.5 rounded-xl bg-slate-800/30 text-white hover:text-pink-300 hover:bg-slate-800/80 transition-all duration-200 group whitespace-nowrap relative">
                        <i data-lucide="book-open" class="w-5 h-5 text-pink-400"></i>
                        <span class="font-bold text-shadow">Docs</span>
                    </a>
                </div>
                
                <!-- Auth Section -->
                <div class="flex items-center gap-3 flex-shrink-0 relative z-20">
                    <!-- Clerk User Button -->
                    <div th:if="${publishableKey != null && !publishableKey.isBlank()}" 
                         id="clerk-user-button-nav" 
                         class="clerk-nav-button relative"></div>
                    
                    <!-- Sign in Button -->
                    <a th:if="${publishableKey != null && !publishableKey.isBlank()}"
                       id="clerk-nav-signin"
                       class="flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-blue-500 to-violet-500 hover:from-blue-600 hover:to-violet-600 text-white font-semibold rounded-full shadow-lg shadow-blue-500/30 hover:shadow-blue-500/50 transition-all duration-200 transform hover:scale-105 relative"
                       href="/signin">
                        <i data-lucide="log-in" class="w-4 h-4"></i>
                        <span>Sign in</span>
                    </a>
                    
                    <!-- Fallback Logout -->
                    <form th:if="${(publishableKey == null || publishableKey.isBlank()) && #httpServletRequest?.remoteUser != null}" 
                          th:action="@{/logout}" 
                          method="post"
                          class="m-0 relative">
                        <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" />
                        <button type="submit" class="flex items-center gap-2 px-5 py-2.5 bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 hover:border-red-500/50 text-red-400 hover:text-red-300 font-semibold rounded-full transition-all duration-200 transform hover:scale-105 relative">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            <span>Logout</span>
                        </button>
                    </form>
                    
                    <!-- Mobile Menu Button (Only for small screens) -->
                    <button id="mobile-menu-toggle" class="md:hidden p-2 text-slate-300 hover:text-white hover:bg-slate-800/50 rounded-xl transition-all duration-200 relative">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
            
            <!-- Mobile Menu (Only for small screens) -->
            <div id="mobile-menu" class="hidden md:hidden border-t border-slate-700/50 mt-2 py-4 px-4 animate-fadeIn relative z-10">
                <div class="flex flex-col gap-2">
                    <a href="/dashboard" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-200 hover:text-white hover:bg-slate-800/70 transition-all duration-200 relative">
                        <i data-lucide="layout-dashboard" class="w-5 h-5 text-blue-400"></i>
                        <span class="font-medium">Dashboard</span>
                    </a>
                    <a href="/test-management" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-200 hover:text-white hover:bg-slate-800/70 transition-all duration-200 relative">
                        <i data-lucide="flask-conical" class="w-5 h-5 text-violet-400"></i>
                        <span class="font-medium">Tests</span>
                    </a>
                    <a href="/scheduler" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-200 hover:text-white hover:bg-slate-800/70 transition-all duration-200 relative">
                        <i data-lucide="clock" class="w-5 h-5 text-amber-400"></i>
                        <span class="font-medium">Scheduler</span>
                    </a>
                    <a href="/regression-monitoring" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-200 hover:text-white hover:bg-slate-800/70 transition-all duration-200 relative">
                        <i data-lucide="activity" class="w-5 h-5 text-green-400"></i>
                        <span class="font-medium">Regression</span>
                    </a>
                    <a href="/reports" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-200 hover:text-white hover:bg-slate-800/70 transition-all duration-200 relative">
                        <i data-lucide="file-bar-chart" class="w-5 h-5 text-cyan-400"></i>
                        <span class="font-medium">Reports</span>
                    </a>
                    <a href="/docs" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-200 hover:text-white hover:bg-slate-800/70 transition-all duration-200 relative">
                        <i data-lucide="book-open" class="w-5 h-5 text-pink-400"></i>
                        <span class="font-medium">Docs</span>
                    </a>
                </div>
            </div>
        </nav>
    </div>
    
    <!-- Initialize Lucide Icons and Mobile Menu -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Lucide Icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // Mobile Menu Toggle
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const mobileMenu = document.getElementById('mobile-menu');
            
            if (mobileMenuToggle && mobileMenu) {
                mobileMenuToggle.addEventListener('click', function() {
                    mobileMenu.classList.toggle('hidden');
                    
                    // Reinitialize icons after menu is shown
                    if (!mobileMenu.classList.contains('hidden') && typeof lucide !== 'undefined') {
                        setTimeout(() => lucide.createIcons(), 50);
                    }
                });
                
                // Close mobile menu when clicking outside
                document.addEventListener('click', function(event) {
                    if (!mobileMenuToggle.contains(event.target) && !mobileMenu.contains(event.target)) {
                        mobileMenu.classList.add('hidden');
                    }
                });
            }
        });
    </script>
    
    <!-- Clerk integration script -->
    <script th:if="${publishableKey != null && !publishableKey.isBlank()}"
            th:inline="javascript">
        /*<![CDATA[*/
        (function() {
            const publishableKey = /*[[${publishableKey}]]*/ '';
            if (!publishableKey) return;
            
            // Load Clerk script if not already loaded
            if (!document.querySelector('script[data-clerk-publishable-key]')) {
                const script = document.createElement('script');
                script.async = true;
                script.crossOrigin = 'anonymous';
                script.setAttribute('data-clerk-publishable-key', publishableKey);
                script.src = 'https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js';
                document.head.appendChild(script);
                
                script.onload = function() {
                    initClerkNav();
                };
            } else {
                // Script already loaded, initialize immediately
                initClerkNav();
            }
            
            async function initClerkNav() {
                if (!window.Clerk) return;
                
                try {
                    await window.Clerk.load();
                    const userButton = document.getElementById('clerk-user-button-nav');
                    const signInLink = document.getElementById('clerk-nav-signin');
                    
                    if (window.Clerk.user) {
                        // User is signed in - show user button, hide sign in link
                        if (signInLink) {
                            signInLink.style.display = 'none';
                        }
                        if (userButton) {
                            window.Clerk.mountUserButton(userButton, {
                                afterSignOutUrl: '/',
                                appearance: {
                                    elements: {
                                        userButtonBox: 'clerk-user-box',
                                        userButtonTrigger: 'clerk-user-trigger'
                                    }
                                }
                            });
                        }
                    } else {
                        // User is not signed in - show sign in link
                        if (signInLink) {
                            signInLink.style.display = 'flex';
                        }
                    }
                } catch (error) {
                    console.error('Clerk initialization error:', error);
                }
            }
        })();
        /*]]>*/
    </script>
</div>
